# ================================
# Namespace: manage all resources
# ================================
apiVersion: v1
kind: Namespace
metadata:
  name: mongo-node-nginx-app

---
# ------------------------
# Secret: MongoDB credentials
# ------------------------
apiVersion: v1
kind: Secret
metadata:
  name: mongo-credentials
  namespace: mongo-node-nginx-app
type: Opaque
stringData:
  MONGO_INITDB_ROOT_USERNAME: root
  MONGO_INITDB_ROOT_PASSWORD: example
  MONGO_URI: mongodb://root:example@mongo:27017/todo?authSource=admin

---
# ------------------------
# ConfigMap: MongoDB initialization scripts
# ------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongo-init-scripts
  namespace: mongo-node-nginx-app
data:
  mongo-init.js: |
    const dbname = 'todo';
    db = db.getSiblingDB(dbname);
    db.createCollection('tasks');
    db.tasks.insertMany([
      { task: 'Buy groceries from kubernetes', completed: false, createdAt: new Date() },
      { task: 'Walk the dog', completed: true, createdAt: new Date() },
      { task: 'Read a book', completed: false, createdAt: new Date() }
    ]);

---
# ------------------------
# Mongo: StatefullSet + PVC
# ------------------------
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongo
  namespace: mongo-node-nginx-app
spec:
  selector:
    matchLabels:
      app: mongo
  serviceName: mongo-service
  replicas: 1
  template:
    metadata:
      labels:
        app: mongo
    spec:
      containers:
        - name: mongo
          image: mongo:7
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 27017
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongo-credentials
                  key: MONGO_INITDB_ROOT_USERNAME
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongo-credentials
                  key: MONGO_INITDB_ROOT_PASSWORD
          volumeMounts:
            - name: mongo-data
              mountPath: /data/db
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d/mongo-init.js
              subPath: mongo-init.js
          livenessProbe:
            tcpSocket:
              port: 27017
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 27017
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: init-scripts
          configMap:
            name: mongo-init-scripts
            defaultMode: 0444
  volumeClaimTemplates:
    - metadata:
        name: mongo-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi

---
# ------------------------
# Mongo Service: ClusterIP
# ------------------------
apiVersion: v1
kind: Service
metadata:
  name: mongo
  namespace: mongo-node-nginx-app
spec:
  selector:
    app: mongo
  ports:
    - port: 27017
      targetPort: 27017

---
# ------------------------
# API Deployment: Node.js app, 2 replicas, with liveness and readiness probes
# ------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: node-app-deployment
  namespace: mongo-node-nginx-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: node-app
  template:
    metadata:
      labels:
        app: node-app
    spec:
      containers:
      - name: node-app
        image: node-app:latest
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 3000
        env:
          - name: NODE_ENV
            value: "production"
          - name: PORT
            value: "3000"
          - name: MONGO_URI
            valueFrom:
              secretKeyRef:
                name: mongo-credentials
                key: MONGO_URI
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 5
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "256Mi"

---
# ------------------------
# Node app service: ClusterIP
# ------------------------
apiVersion: v1
kind: Service
metadata:
  name: node-app-service
  namespace: mongo-node-nginx-app
spec:
  selector:
    app: node-app
  ports:
    - name: http
      port: 3000
      targetPort: 3000

---
# ------------------------
# Nginx ConfigMap. Replace the content of the ./nginx/default.prod.conf file.
# It will replace the /api/* calls to point to the Node.js app service.
# ------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: mongo-node-nginx-app
data:
  default.conf: |
    server {
      listen 80;

      location = / {
          default_type text/plain;
          return 200 'NGINX is working in development mode! Please try /api/health or /api/tasks';
      }

      location /api/ {
        proxy_pass http://node-app-service:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
      }
    }

---
# ------------------------
# Nginx Deployment
# ------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: mongo-node-nginx-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 80
        volumeMounts:
          - name: nginx-config-volume
            mountPath: /etc/nginx/conf.d/default.conf
            subPath: default.conf
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
        - name: nginx-config-volume
          configMap:
            name: nginx-config
            defaultMode: 0444

---
# ------------------------
# Nginx Service: NodePort
# ------------------------
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: mongo-node-nginx-app
spec:
  type: ClusterIP
  selector:
    app: nginx
  ports:
    - name: http
      port: 80
      targetPort: 80

---
# ------------------------
# Ingress: forwarding to Nginx service
# ------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-ingress
  namespace: mongo-node-nginx-app
  annotations:
    # if you need rewrite rules, uncomment the line below and adjust accordingly
    # nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - host: localhost # AI suggests to use todo.local and add it to /etc/hosts, but localhost is easier for testing
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: nginx-service
                port:
                  number: 80